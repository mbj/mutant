name: CI

on: push

jobs:
  base:
    name: Base steps
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check Whitespace
      run: git diff --check -- HEAD~1
  rust-build:
    name: Rust Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-15
          - target: aarch64-unknown-linux-musl
            os: ubuntu-24.04-arm
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          - target: x86_64-unknown-linux-musl
            os: ubuntu-24.04
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - uses: actions/cache@v4
      with:
        path: |
          target/
          ~/.cargo/bin/
          ~/.cargo/git/db/
          ~/.cargo/registry/cache/
          ~/.cargo/registry/index/
          ~/.rustup
        key: ${{ matrix.target }}-rust-${{ hashFiles('.github/workflows/ci.yml', 'Cargo.lock', 'rust-toolchain.toml') }}
    - name: Install musl-tools
      if: endsWith(matrix.target, '-musl')
      run: sudo apt-get update && sudo apt-get install -y musl-tools
    - name: Run fmt
      run: cargo fmt --check
    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}
    - name: Run clippy
      run: cargo clippy --release --target ${{ matrix.target }}
    - uses: actions/upload-artifact@v4
      with:
        name: manager-${{ matrix.target }}
        path: target/${{ matrix.target }}/release/manager
  ruby-tests:
    name: Ruby Tests
    needs: rust-build
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        ruby: [ruby-3.2, ruby-3.3, ruby-3.4]
        target:
          - aarch64-apple-darwin
          - aarch64-unknown-linux-musl
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - x86_64-unknown-linux-gnu
        execution:
          - mutant run -- --zombie --since HEAD~1
          - mutant test
          - rspec integration generation
          - rspec integration minitest
          - rspec integration misc
          - rspec integration rspec
          - rspec unit
          - rubocop
        include:
          - target: aarch64-apple-darwin
            os: macos-15
          - target: aarch64-unknown-linux-musl
            os: ubuntu-24.04-arm
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          - target: x86_64-unknown-linux-musl
            os: ubuntu-24.04
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: actions/download-artifact@v4
      with:
        name: manager-${{ matrix.target }}
        path: ./bin
    - run: chmod +x ./bin/manager
    - run: ./bin/manager ruby prepare
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
        working-directory: ./ruby
    - run: ./bin/manager ruby ${{ matrix.execution }}
